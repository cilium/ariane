name: Release

on:
  workflow_dispatch: {}
  schedule:
    - cron: "30 1 1-7,15-21 * 1"

# By specifying the access of one of the scopes, all of those that are not
# specified are set to 'none'.
permissions:
  # To be able to access the repository with actions/checkout
  contents: read
  # Required to generate OIDC tokens for GCP authentication
  id-token: write
  # Required to query workflow runs via GitHub API
  actions: read

jobs:
  check-for-changes:
    name: Check for changes
    runs-on: ubuntu-24.04
    outputs:
      result: ${{ steps.check-commits.outputs.result }}
    steps:
      - name: Check for new commits since last deployment
        id: check-commits
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: string
          script: |
            const currentSha = context.sha;

            // Get the last successful run of this workflow
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'release.yaml',
              status: 'success',
              per_page: 1
            });

            if (!runs.workflow_runs || runs.workflow_runs.length === 0) {
              console.log('No previous successful deployment found, proceeding with deployment');
              return true;
            }

            const lastDeploySha = runs.workflow_runs[0].head_sha;

            if (lastDeploySha === currentSha) {
              console.log(`HEAD did not move, skipping deployment`);
              return false;
            }

            return true;

  build-and-deploy:
    concurrency:
      group: ${{ github.workflow }}
    name: Build and deploy to GCP
    environment: production
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Generate server configuration
        run: |
          TAG=$(date +%Y%m%d%H%M)-$(git log -1 --pretty=%h)
          echo "TAG=${TAG}" >> $GITHUB_ENV

          GH_APP_PRIVATE_KEY_ESCAPED=$(echo "${{ secrets.GH_APP_PRIVATE_KEY }}" | sed ':a;N;$!ba;s/\n/\\n/g')
          echo "::add-mask::${GH_APP_PRIVATE_KEY_ESCAPED}"

          cat <<EOF | tee -a app.yaml
          service: default
          env_variables:
            ARIANE_VERSION: ${TAG}
            ARIANE_SERVER_PORT: 8080
            ARIANE_SERVER_ADDRESS: "0.0.0.0"
            ARIANE_CLIENT_TIMEOUT: 10s
            ARIANE_MAX_RETRY_ATTEMPTS: 3
            ARIANE_RUN_DELAY: 30s
            GITHUB_V3_API_URL: ${{ vars.GH_V3_API_URL }}
            GITHUB_APP_INTEGRATION_ID: ${{ secrets.GH_APP_INTEGRATION_ID }}
            GITHUB_APP_WEBHOOK_SECRET: ${{ secrets.GH_APP_WEBHOOK_SECRET }}
            GITHUB_APP_PRIVATE_KEY: ${GH_APP_PRIVATE_KEY_ESCAPED}
          EOF

      - name: Log in to GCP
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # v3.0.0
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup Docker
        uses: docker/setup-docker-action@e43656e248c0bd0647d3f5c195d116aacf6fcaf4 # v4.7.0

      - name: Docker Login
        run: gcloud auth configure-docker

      - name: Build Docker image
        id: build-image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: ${{ github.workspace }}
          file: Dockerfile
          push: true
          tags: |
            gcr.io/${{ secrets.GCP_PROJECT_ID }}/ariane:${{ env.TAG }}

      - name: Deploy to GCP App Engine
        run: |
          gcloud app deploy --quiet \
            --image-url=gcr.io/${{ secrets.GCP_PROJECT_ID }}/ariane:${{ env.TAG }} \
            ./app.yaml

      - name: Delete old versions
        run: |
          gcloud app versions list --service default --format "value(version.id)" --sort-by "~version.createTime" \
            | tail -n +10 \
            | xargs -r gcloud app versions delete --service default --quiet
